     -----===== Debian Server Set Up for Django Instruction =====-----

## Create user, setup SSH
## Connect through SSH to remote Debian server and update 
## repositories and install some initial needed packages:

-- 1 --
sudo apt-get update 
sudo apt-get install -y vim mosh tmux htop git curl wget unzip zip gcc build-essential make

## Configure SSH:
# Base dir
sudo vim /etc/ssh/sshd_config
    AllowUsers user_name
    PermitRootLogin no
    PasswordAuthentication no

# Restart SSH server, change www user password:
sudo service ssh restart
sudo passwd user_name

## Configure UFW --
#install
sudo apt install ufw

#base dir
sudo vim /etc/default/ufw

# Allow connections
sudo ufw allow ssh  	# 22
sudo ufw allow http   	# 80
sudo ufw allow https  	# 443
sudo ufw allow 60001	# mosh 

sudo ufw allow 6000:6007/tcp
sudo ufw allow 6000:6007/udp

# activation
sudo ufw enable

# New user --
adduser user_name

# Add in sudo grope
usermod -aG sudo user_name

# get the user
su - user_name

# test
sudo upt update

# add user ssh key
# get 
mkdir -p /home/user_name/.ssh && touch /home/user_name/.ssh/authorized_keys

# Add youre ssh pab.key in authorized_keys
vim .ssh/authorized_keys


-- 2 -- 
## Init — must-have packages & ZSH
sudo apt-get install -y zsh tree redis-server nginx zlib1g-dev libbz2-dev libreadline-dev llvm libncurses5-dev libncursesw5-dev xz-utils tk-dev liblzma-dev python3-dev python-imaging python3-lxml libxslt-dev python-libxml2 python-libxslt1 libffi-dev libssl-dev python-dev gnumeric libsqlite3-dev libpq-dev libxml2-dev libxslt1-dev libjpeg-dev libfreetype6-dev libcurl4-openssl-dev supervisor

# Install oh-my-zsh:
sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
Configure some needed aliases:

# Change your default shell
chsh -s $(which zsh)

# Add in .zshrc
export PATH=$PATH:/home/mrleon/.python/bin

# fixed with - mosh  
sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8

-- 3 --
## Install python 3
#
# Check Python version!
#
## Build from source python 3.9,0, install with prefix to ~/.python folder:
wget https://www.python.org/ftp/python/3.9.0/Python-3.9.0.tgz 
tar xvf Python-3.* 
cd Python-3.*  
mkdir ~/.python 
./configure --enable-optimizations --prefix=/home/mrleon/.python
make -j8
sudo make altinstall

# Add path in .bashrc
export PATH=$PATH:/home/mrleon/.python/bin

## Now python3.9 in /home/www/.python/bin/python3.9. Update pip:
sudo /home/mrleon/.python/bin/python3.9 -m pip install -U pip

Ok, now we can pull our project from Git repository (or create own), create and activate Python virtual environment:

# git clone project_git
# cd project_dir
python3.9 -m venv venv
. ./env/bin/activate

-- 4 --
## Install and configure PostgreSQL
# Install PostgreSQL 12 and configure locales.

wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - 
RELEASE=$(lsb_release -cs) 
echo "deb http://apt.postgresql.org/pub/repos/apt/ ${RELEASE}"-pgdg main | sudo tee  /etc/apt/sources.list.d/pgdg.list 
sudo apt update 
sudo apt -y install postgresql-12 

# locale RU
sudo localedef ru_RU.UTF-8 -i ru_RU -fUTF-8 ; \
export LANGUAGE=ru_RU.UTF-8 ; \
export LANG=ru_RU.UTF-8 ; \
export LC_ALL=ru_RU.UTF-8 ; \
sudo locale-gen ru_RU.UTF-8 ; \
sudo dpkg-reconfigure locales

# Add locales to /etc/profile:
sudo vim /etc/profile ; \
    export LANGUAGE=ru_RU.UTF-8 ; \
    export LANG=ru_RU.UTF-8 ; \
    export LC_ALL=ru_RU.UTF-8

# Change postges password, create clear database named dbms_db:
sudo passwd postgres
su - postgres
export PATH=$PATH:/usr/lib/postgresql/11/bin
createdb --encoding UNICODE dbms_db --username postgres
exit

# Create dbms db user and grand privileges to him:
sudo -u postgres psql
postgres=# ...
create user user_name with password 'some_password';
ALTER USER dbms CREATEDB;
grant all privileges on database dbms_db to dbms;
\c dbms_db

GRANT ALL ON ALL TABLES IN SCHEMA public to dbms;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public to dbms;
GRANT ALL ON ALL FUNCTIONS IN SCHEMA public to dbms;
CREATE EXTENSION pg_trgm;
ALTER EXTENSION pg_trgm SET SCHEMA public;
UPDATE pg_opclass SET opcdefault = true WHERE opcname='gin_trgm_ops';
\q
exit

# Now we can test connection. Create ~/.pgpass with login and password to db for fast connect:
vim ~/.pgpass
	localhost:5432:dbms_db:dbms:some_password
chmod 600 ~/.pgpass
psql -h localhost -U dbms dbms_db

# Run SQL dump, if you have:
psql -h localhost dbms_db dbms  < dump.sql

-- 5 --
## Install and configure supervisor
# Now recommended way is using Systemd instead of supervisor. 
# If you need supervisor — welcome:

sudo apt install supervisor

vim /home/www/code/project/bin/start_gunicorn.sh
	#!/bin/bash
	source /home/name/code/project/env/bin/activate
	source /home/name/code/project/env/bin/postactivate
	exec gunicorn  -c "/home/name/code/project/gunicorn_config.py" project.wsgi

chmod +x /home/www/code/project/bin/start_gunicorn.sh

vim project/supervisor.salesbeat.conf
	[program:name_gunicorn]
	command=/home/name/code/project/bin/start_gunicorn.sh
	user=name
	process_name=%(program_name)s
	numprocs=1
	autostart=true
	autorestart=true
	redirect_stderr=true

-- 6 --
## Gunicorn example config:
command = '/home/name/code/project/env/bin/gunicorn'
pythonpath = '/home/name/code/project/project'
bind = '127.0.0.1:8001'
workers = 3
user = 'name'
limit_request_fields = 32000
limit_request_field_size = 0
raw_env = 'DJANGO_SETTINGS_MODULE=project.settings'
